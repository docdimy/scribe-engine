# Scribe Engine - Backend Service Requirements

This document lists all necessary tasks for a lean, scalable, and secure backend that processes audio data, orchestrates STT and LLM services, and delivers validated HL7 FHIR R4 responses.

---

### 1. Minimized Technology Stack

- **1.1. Programming Language & Framework:** ‚úÖ **Done**
  - Python 3.10+ with FastAPI (lightweight, ASGI).
  - venv + pip for virtual environment and dependencies.

- **1.2. HTTP Client and SDKs:** ‚úÖ **Done**
  - `httpx` (async) for REST calls.
  - OpenAI Python SDK (`openai`).
  - AssemblyAI Python SDK (`assemblyai`).
  - FHIR Resources SDK (`fhir.resources`).

- **1.3. Audio Validation:** ‚úÖ **Done**
  - Checks `Content-Type`, max audio duration (‚â§ 600 seconds), and file size.
  - Rejects non-compliant requests with HTTP 415 (Format) or 413 (Size).

---

### 2. Endpoint Implementation

- **2.1. `POST /v1/transcribe`:** ‚úÖ **Done**
  - Asynchronously reads the request body.
  - All specified query parameters are implemented:
    - `model` (enum: `gpt-4.1-nano`/`gpt-4o-mini`/`gpt-4o`)
    - `diarization` (bool)
    - `language` (ISO 639-1 code or `auto`)
    - `output_language` (ISO 639-1 code, defaults to input)
    - `output_format` (enum: `json`/`xml`/`fhir`)
    - `fhir_bundle_type` (enum: `document`/`transaction`)
    - `specialty` (string)
    - `conversation_type` (string)
  - Duration check (‚â§ 10 minutes) is implemented.
  - OpenAPI documentation is automatically generated by FastAPI.

---

### 3. STT Integration

- **3.1. Without Diarization:** ‚úÖ **Done** (Adapter for OpenAI).
- **3.2. With Diarization:** ‚úÖ **Done** (Adapter for AssemblyAI).
- **3.3. Error and Timeout Handling:** ‚úÖ **Done** (Timeout 60s, max 3 retries with exponential backoff).
- **3.4. Language Support:** ‚úÖ **Done**
  - Supports configured ISO 639-1 set plus `auto`.
  - Forwards `language` to the STT provider; `auto` delegates detection.
  - Validation and audit logging of the used language.

---

### 4. Prompt Generation

- **4.1. `build_prompt` function:** ‚úÖ **Done** (Logic is integrated into `llm_service.py`).
- **4.2. System Prompt:** ‚úÖ **Done** (Acts as a medical assistant).
- **4.3. Context Inclusion:** ‚úÖ **Done** (Includes `specialty` and `conversation_type`).
- **4.4. Output Language:** ‚úÖ **Done** (Instructs the model to respond in the desired language).

---

### 5. LLM Integration

- **5.1. OpenAI Chat Completions:** ‚úÖ **Done** (Models: `gpt-4.1-nano`, `gpt-4o-mini`, `gpt-4o`).
- **5.2. Configuration:** ‚úÖ **Done** (`temperature=0.0`, configurable `max_tokens`).
- **5.3. Async & Retries:** ‚úÖ **Done** (Async HTTP client, timeout 60s, exponential backoff with max 3 retries).

---

### 6. Output Serialization

- **6.1. FHIR R4:** ‚úÖ **Done** (via `fhir.resources`).
- **6.2. XML:** ‚úÖ **Done**.
- **6.3. JSON:** ‚úÖ **Done**.

---

### 7. API Versioning

- **7.1. Path Prefix `/v1/`:** ‚úÖ **Done**.
- **7.2. Header Versioning:** ‚ùå **Open**. Versioning via `Accept` header is not implemented.
- **7.3. Invalid Version Handling:** ‚ùå **Open**.

---

### 8. Health Checks

- **8.1. Endpoints `/health` and `/ready`:** ‚úÖ **Done** (Slightly different naming, but same function as `/health/live`).
- **8.2. Liveness:** ‚úÖ **Done** (Process check returns HTTP 200).
- **8.3. Readiness:** ‚úÖ **Done** (Checks ENV variables & API provider reachability, returns HTTP 200/503).

---

### 9. Error Handling & Retries

- **9.1. Timeouts:** ‚úÖ **Done** (STT 60s, LLM 60s).
- **9.2. Exponential Backoff:** ‚úÖ **Done** (Max 3 retries).
- **9.3. Error Responses:** ‚úÖ **Done** (`HTTPException` (e.g., 502/504) with clear details).

---

### 10. Rate Limiting & Authentication

- **10.1. Authentication:** ‚úÖ **Done** (API Key in Bearer token).
- **10.2. Rate Limits:** ‚úÖ **Done** (e.g., 10 req/min).
- **10.3. Error Codes:** ‚úÖ **Done** (HTTP 401 for missing auth, HTTP 429 for limit exceeded).

---

### 11. User Control

- **11.1. Frontend Whitelist:** ‚úÖ **Done** (via CORS `Origin` header).
- **11.2. JWT Authentication:** ‚úÖ **Done** (Service can validate JWTs).
- **11.3. Paywall:** ‚ùå **Open**. Quota management (audio minutes/credits) and HTTP 402 response are not implemented.

---

### 12. FHIR Semantics & Validation

- **12.1. `fhir.resources` Usage:** ‚úÖ **Done**.
- **12.2. Validation:** ‚úÖ **Done** (Implicitly handled by `fhir.resources` on serialization).

---

### 13. Security & Compliance

- **13.1. TLS 1.2+:** üü° **Pending**. This is not part of the application code but must be enforced by a reverse proxy (e.g., Nginx, Traefik) during production deployment. See Task 15.3.
- **13.2. Encryption-at-Rest:** ‚úÖ **Done**. Audio data is encrypted with a strong symmetric key (`Fernet`) before being temporarily written to disk and decrypted in memory for processing.
- **13.3. Audit Logging:** ‚úÖ **Done** (Logs API key hash, timestamp, endpoint).
- **13.4. Deletion:** ‚úÖ **Done** (Encrypted audio files are deleted immediately after processing).
- **13.5. GDPR:** ‚úÖ **Done** (Data flow and deletion processes are documented and implemented).

---

### 14. CI/CD

- **14.1. Linting/Type-Checks:** ‚ùå **Open**.
- **14.2. Security Scans:** ‚ùå **Open**.
- **14.3. Automated Build & Deployment:** ‚ùå **Open**.
  - The example workflow below is a template and not yet active.

```yaml
# Example GitHub Actions Workflow (.github/workflows/ci-cd.yml)
name: CI/CD Pipeline
on:
  push:
    branches: [ main, develop ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt
          pip install black flake8 mypy bandit # Install dev dependencies
      - name: Lint with Black & Flake8
        run: |
          . .venv/bin/activate
          black --check .
          flake8 .
      - name: Type-check with Mypy
        run: |
          . .venv/bin/activate
          mypy .
      - name: Security scan with Bandit
        run: |
          . .venv/bin/activate
          bandit -r app
  deploy-to-dockerhub:
    needs: build-and-test
    if: github.ref == 'refs/heads/main' # Only run for main branch
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile
          push: true
          tags: your-dockerhub-user/scribe-engine:latest
```

---

### 15. Deployment & Hosting

- **15.1. Synology Webstation (Test):** ‚úÖ **Done** (Can be deployed via Docker).
- **15.2. Production with Docker:** ‚úÖ **Done** (Multi-stage Dockerfile and production compose file exist).
- **15.3. Production Reverse Proxy:** ‚ùå **Open**. A reverse proxy (e.g., Nginx, Traefik) must be configured to provide TLS termination (HTTPS) for the production environment. This proxy will handle incoming public traffic and forward it to the Scribe-Engine container.

```yaml
# Example docker-compose.yml for production deployment with a proxy
# This setup assumes a reverse proxy is running on the same host network.
version: '3.8'
services:
  scribe-engine:
    image: your-dockerhub-user/scribe-engine:latest
    container_name: scribe-engine
    ports:
      - '3001:3001' # Port updated to 3001
    env_file:
      - .env.production
    restart: unless-stopped
```

---
